é€™é¡Œè¶…ç¶“å…¸ï¼Œä½†å¦‚æœä½ çœŸçš„ææ‡‚å®ƒï¼Œä½ åœ¨ C++ çš„æŠ½è±¡å±¤æ¬¡èˆ‡æ•ˆèƒ½æ€ç¶­ä¸Šæœƒç›´æ¥å‡ä¸€éšã€‚
æˆ‘å€‘ç›´æ¥ä¾†é–‹å‰–ã€Œéœæ…‹å¤šå‹ (Static Polymorphism)ã€ vs ã€Œå‹•æ…‹å¤šå‹ (Dynamic Polymorphism)ã€çš„æ ¸å¿ƒå·®ç•°ã€åŸç†èˆ‡æ‡‰ç”¨å ´æ™¯ã€‚

ğŸš€ ä¸€ã€åŸºæœ¬å®šç¾©å°ç…§

| é …ç›®    | éœæ…‹å¤šå‹ (Static Polymorphism)    | å‹•æ…‹å¤šå‹ (Dynamic Polymorphism) |
| ----- | ----------------------------- | --------------------------- |
| ç™¼ç”Ÿæ™‚æ©Ÿ  | ç·¨è­¯æœŸ (compile-time)            | åŸ·è¡ŒæœŸ (runtime)               |
| å¯¦ç¾æ–¹å¼  | **æ¨¡æ¿ (templates)** æˆ– **CRTP** | **è™›å‡½å¼ (virtual functions)** |
| ç¶å®šæ–¹å¼  | **éœæ…‹ç¶å®š (static binding)**     | **å‹•æ…‹ç¶å®š (dynamic binding)**  |
| åŸ·è¡Œæ•ˆç‡  | ç„¡è™›æ“¬è¡¨é–‹éŠ·ï¼Œé€Ÿåº¦å¿«                    | ç¶“ç”± vtable æŸ¥è¡¨ï¼Œæœ‰å°‘è¨±é–‹éŠ·          |
| å¯æ“´å……æ€§  | ç·¨è­¯æœŸæ±ºå®šï¼Œä¸æ”¯æ´å‹•æ…‹å‹åˆ¥                 | å¯å‹•æ…‹æ±ºå®šå‹åˆ¥ï¼Œæ”¯æ´å¤šå‹æŒ‡æ¨™              |
| è¨˜æ†¶é«”è² æ“” | ç„¡ vtableï¼Œè¼ƒè¼•                   | æ¯å€‹æœ‰è™›å‡½å¼çš„é¡åˆ¥å« vptr             |


ğŸ§© äºŒã€ç¯„ä¾‹æ¯”è¼ƒ
âœ… å‹•æ…‹å¤šå‹ä¾‹å­ï¼ˆä½¿ç”¨ virtualï¼‰

``` cpp
#include <iostream>
using namespace std;

class Animal {
public:
    virtual void speak() { cout << "Animal sound\n"; }
    virtual ~Animal() = default; // åˆ¥å¿˜è¨˜è™›ææ§‹
};

class Dog : public Animal {
public:
    void speak() override { cout << "Woof!\n"; }
};

void makeSound(Animal& a) {
    a.speak(); // åŸ·è¡ŒæœŸç”± vtable æ±ºå®šå‘¼å«å“ªå€‹ speak()
}

int main() {
    Dog d;
    makeSound(d); // åŸ·è¡ŒæœŸæ±ºå®šå‘¼å« Dog::speak()
}
```

ğŸ§  èªªæ˜ï¼š

- ç·¨è­¯æ™‚ä¸çŸ¥é“ a å…·é«”æ˜¯å“ªå€‹å‹åˆ¥ã€‚
- åŸ·è¡ŒæœŸè—‰ç”±ã€Œè™›æ“¬è¡¨æŒ‡æ¨™ (vptr)ã€æŸ¥è¡¨å‘¼å«å°æ‡‰çš„å‡½å¼ã€‚
- æœ‰å½ˆæ€§ï¼Œä½†å¤šä¸€å±¤ indirectionã€‚

âš¡ éœæ…‹å¤šå‹ä¾‹å­ï¼ˆä½¿ç”¨ CRTPï¼‰

``` cpp
#include <iostream>
using namespace std;

// CRTPï¼šCuriously Recurring Template Pattern
template <typename Derived>
class Animal {
public:
    void makeSound() {
        static_cast<Derived*>(this)->speak(); // ç·¨è­¯æœŸç¶å®š
    }
};

class Dog : public Animal<Dog> {
public:
    void speak() { cout << "Woof!\n"; }
};

int main() {
    Dog d;
    d.makeSound(); // ç·¨è­¯æœŸå·²çŸ¥å‘¼å« Dog::speak()
}
```

ğŸ§  èªªæ˜ï¼š

- æ²’æœ‰ virtualï¼Œä¹Ÿæ²’æœ‰ vtableã€‚
- é€éæ¨¡æ¿åƒæ•¸åœ¨ç·¨è­¯æœŸæ±ºå®šå…·é«”é¡åˆ¥ã€‚
- ç·¨è­¯å™¨å¯ inline ç”šè‡³å„ªåŒ–æ‰æ•´å€‹å‘¼å«éˆï¼Œé›¶é–‹éŠ·ã€‚

âš”ï¸ ä¸‰ã€å„ªç¼ºé»å°æ±º

| é¢å‘       | éœæ…‹å¤šå‹                       | å‹•æ…‹å¤šå‹                   |
| -------- | -------------------------- | ---------------------- |
| **åŸ·è¡Œæ•ˆç‡** | âœ… å¿«ã€å¯ inline               | ```âŒ``` æœ‰ vtable é–‹éŠ·          |
| **å½ˆæ€§**   | ```âŒ``` ç·¨è­¯æœŸæ±ºå®šå‹åˆ¥                  | âœ… åŸ·è¡ŒæœŸæ±ºå®šè¡Œç‚º              |
| **æ“´å±•æ€§**  | ```âŒ``` æ–°å‹åˆ¥éœ€é‡æ–°ç·¨è­¯                 | âœ… å¯ç”¨åŸºé¡æŒ‡æ¨™è™•ç†å¤šç¨®å­é¡         |
| **ç¨‹å¼é«”ç©** | å¯èƒ½è¢«æ¨¡æ¿å±•é–‹è†¨è„¹                  | ç›¸å°ç²¾ç°¡                   |
| **æ‡‰ç”¨å ´æ™¯** | æ•ˆèƒ½å°å‘ï¼ˆe.g. æ•¸å€¼è¨ˆç®—ã€GPU kernelï¼‰ | æ¶æ§‹å°å‘ï¼ˆe.g. pluginã€äº‹ä»¶åˆ†æ´¾ï¼‰ |


ğŸ§  å››ã€åº•å±¤è¦–è§’

- å‹•æ…‹å¤šå‹
    æ¯å€‹å«è™›å‡½å¼çš„é¡åˆ¥éƒ½æœ‰ä¸€å€‹ vtable (è™›æ“¬å‡½å¼è¡¨)ï¼Œç‰©ä»¶å…§éƒ¨æœƒè—ä¸€å€‹æŒ‡æ¨™ï¼ˆvptrï¼‰æŒ‡å‘è©²è¡¨ã€‚
    å‘¼å«è™›å‡½å¼æ™‚ â†’ ç·¨è­¯å™¨ç”¢ç”Ÿ obj->vptr[n]() æŸ¥è¡¨å‘¼å«ã€‚

- éœæ…‹å¤šå‹
    å®Œå…¨æ²’æœ‰ vptr æˆ– vtableï¼Œ
    å› ç‚º Derived é¡å‹åœ¨ç·¨è­¯æœŸå·²ç¢ºå®šï¼Œç·¨è­¯å™¨ç›´æ¥å±•é–‹å¯¦éš›å‡½å¼å‘¼å«ã€‚

ğŸ§ª äº”ã€æ··åˆæ‡‰ç”¨ (Hybrid Pattern)

æœ‰æ™‚ä½ å¯ä»¥çµåˆå…©è€…ï¼š
ä¾‹å¦‚åœ¨é«˜æ•ˆçš„æ¨è«–ç³»çµ±ä¸­ï¼Œä½ å¯ä»¥ç”¨ CRTP æä¾›éœæ…‹ä»‹é¢æ¨¡æ¿ï¼Œä½†åœ¨æœ€å¤–å±¤ plugin manager ç”¨ virtual æä¾›å‹•æ…‹åˆ‡æ›æ¨¡çµ„èƒ½åŠ›ã€‚

``` cpp
template <typename Derived>
class FilterBase {
public:
    void process() {
        static_cast<Derived*>(this)->impl(); // éœæ…‹å¤šå‹
    }
};

class GaussianFilter : public FilterBase<GaussianFilter> {
public:
    void impl() { cout << "Gaussian\n"; }
};

// runtime polymorphism å°è£
class IFilter {
public:
    virtual void process() = 0;
    virtual ~IFilter() = default;
};
```

â†’ é€™æ¨£å…§å±¤å¿«ã€å¤–å±¤å½ˆæ€§å¼·ï¼Œç®—æ˜¯é«˜éš C++ è¨­è¨ˆå¸¸è¦‹åšæ³•ã€‚

ğŸ¯ çµè«–ï¼ˆä¸€å¥è©±è¨˜ä½ï¼‰
    ğŸ§© éœæ…‹å¤šå‹ï¼š å‹åˆ¥åœ¨ã€Œç·¨è­¯æœŸã€æ±ºå®šï¼Œè¿½æ±‚æ•ˆèƒ½ã€‚
    ğŸ§© å‹•æ…‹å¤šå‹ï¼š è¡Œç‚ºåœ¨ã€ŒåŸ·è¡ŒæœŸã€æ±ºå®šï¼Œè¿½æ±‚å½ˆæ€§ã€‚
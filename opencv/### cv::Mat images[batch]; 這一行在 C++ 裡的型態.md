### cv::Mat images[batch]; é€™ä¸€è¡Œåœ¨ C++ è£¡çš„å‹æ…‹ (type)

ğŸ§  å‹æ…‹åˆ†æ
å‡è¨­ï¼š

``` cpp
int batch = 8;
cv::Mat images[batch];
```

é‚£ images çš„å‹æ…‹æ˜¯ï¼š

``` cpp
cv::Mat [batch]
```

ä¹Ÿå°±æ˜¯ã€Œä¸€å€‹é•·åº¦ç‚º batch çš„ cv::Mat é™£åˆ—ã€ã€‚

ğŸ“¦ å…ƒç´ å‹æ…‹
é™£åˆ—ä¸­æ¯ä¸€å€‹å…ƒç´ çš„å‹æ…‹éƒ½æ˜¯ï¼š
**cv::Mat**
æ‰€ä»¥ä½ å¯ä»¥åƒé€™æ¨£ä½¿ç”¨ï¼š

```cpp
images[0] = cv::imread("a.jpg");
images[1] = cv::imread("b.jpg");
```

ğŸ§© æŒ‡æ¨™æ¨å°
åœ¨å‡½å¼åƒæ•¸æˆ–å‚³éæ™‚ï¼Œå¦‚æœä½ æŠŠé€™å€‹é™£åˆ—åç¨±ï¼ˆimagesï¼‰ç•¶æˆåƒæ•¸å‚³éï¼Œæœƒè‡ªå‹•è¡°é€€ (decay) æˆæŒ‡æ¨™ï¼š

``` cpp
cv::Mat* ptr = images;
```

é€™è£¡ ptr çš„å‹æ…‹å°±æ˜¯ï¼š
**cv::Mat***

ğŸ§® å°ç…§ç¸½è¦½è¡¨

| è¡¨é”å¼                      | å‹æ…‹                | èªªæ˜         |
| :----------------------- | :---------------- | :--------- |
| `cv::Mat images[batch];` | `cv::Mat [batch]` | å›ºå®šé•·åº¦é™£åˆ—     |
| `images`ï¼ˆç”¨åœ¨å‚³éæ™‚ï¼‰          | `cv::Mat*`        | æŒ‡å‘ç¬¬ä¸€å€‹å…ƒç´ çš„æŒ‡æ¨™ |
| `images[i]`              | `cv::Mat`         | é™£åˆ—ä¸­çš„å–®ä¸€å½±åƒç‰©ä»¶ |

âš ï¸ æ³¨æ„äº‹é …
1. é™£åˆ—é•·åº¦ batch å¿…é ˆæ˜¯ç·¨è­¯æœŸå¸¸æ•¸ï¼ˆåœ¨ C++ æ¨™æº–èªæ³•è£¡ï¼‰ã€‚
è‹¥ä½ å¯«ï¼š

``` cpp
int batch = 8;
cv::Mat images[batch];  // âŒ éæ¨™æº– C++
```

é€™åœ¨ GCC/Clang å¯è¡Œï¼ˆGNU æ“´å……çš„ VLA èªæ³•ï¼‰ï¼Œä½†ä¸å±¬æ–¼æ¨™æº– C++ã€‚
æ­£çµ±å¯«æ³•æ˜¯ç”¨ std::vectorï¼š

``` cpp
std::vector<cv::Mat> images(batch);
```

2. cv::Mat æ˜¯å€‹æ™ºæ…§æŒ‡æ¨™æ¨£çš„ classï¼ˆå…§éƒ¨å…±äº«è¨˜æ†¶é«”ï¼‰ï¼Œæ‰€ä»¥ç”¨é™£åˆ—æˆ– vector ç®¡ç†éƒ½å®‰å…¨ã€‚

### cv::Mat images[batch] è·Ÿ std::vector<cv::Mat> images(batch) åœ¨è¨˜æ†¶é«”é…ç½®èˆ‡å¯å‚³éæ€§ä¸Šçš„å·®ç•°

ğŸ§© ä¸€ã€åŸºæœ¬å®šç¾©èˆ‡å„²å­˜å·®ç•°

| é¢å‘   | `cv::Mat images[batch];`       | `std::vector<cv::Mat> images(batch);`                          |
| ---- | ------------------------------ | -------------------------------------------------------------- |
| å‹æ…‹   | å›ºå®šé•·åº¦é™£åˆ—ï¼ˆstack object arrayï¼‰     | å‹•æ…‹é•·åº¦å®¹å™¨ï¼ˆheap allocationï¼‰                                        |
| é…ç½®ä½ç½® | é€šå¸¸åœ¨ **stackï¼ˆå †ç–Šï¼‰** ä¸Šé…ç½®          | `std::vector` è‡ªèº«åœ¨ **stack** ä¸Šï¼Œä½†å…ƒç´ å®¹å™¨ï¼ˆ`cv::Mat`ï¼‰åœ¨ **heapï¼ˆå †ç©ï¼‰** ä¸Š |
| é•·åº¦å¯è®Š | âŒ ä¸å¯ï¼ˆç·¨è­¯æœŸå¸¸æ•¸ï¼‰                    | âœ… å¯è®Šï¼ˆå¯ `resize()`ã€`push_back()`ï¼‰                               |
| æ”¯æ´ç¯„åœ | åƒ…é™æ¨™æº– C++ éœæ…‹é™£åˆ—å¤§å°ï¼ˆGNU æ”¯æ´è®Šé•·ï¼Œä½†éæ¨™æº–ï¼‰ | å®Œå…¨æ¨™æº–ã€é€šç”¨                                                        |

âš™ï¸ äºŒã€è¨˜æ†¶é«”é…ç½®ç´°ç¯€ï¼ˆä»¥ batch = 8 ç‚ºä¾‹ï¼‰
- cv::Mat images[8];
- åˆ†é…åœ¨ stack ä¸Šï¼š

``` cpp
| Stack frame |
â”œâ”€â”€ images[0] : cv::Mat (ç´„ 32 bytes)
â”œâ”€â”€ images[1] : cv::Mat
â”œâ”€â”€ ...
â””â”€â”€ images[7] : cv::Mat
```

- é€™äº› cv::Mat æ˜¯ç‰©ä»¶ï¼ˆéå¯¦éš›å½±åƒ bufferï¼‰ï¼Œæ¯å€‹ Mat çš„è³‡æ–™ï¼ˆåƒç´ ï¼‰ä»å­˜åœ¨ heap æˆ– GPUã€‚
æ‰€ä»¥ã€Œæ¯å€‹ Mat çš„ header åœ¨ stackï¼Œä¸Šå±¤å¯¦éš›å½±åƒè¨˜æ†¶é«”åœ¨ heapã€ã€‚
- std::vector<cv::Mat> images(8);
- images ç‰©ä»¶æœ¬èº«åœ¨ stack ä¸Šï¼Œå…§éƒ¨ç®¡ç†ä¸€å¡Š heap bufferï¼š

``` cpp
| Stack frame |
â””â”€â”€ std::vector<cv::Mat> images
       â†“
      | Heap |
      â”œâ”€â”€ cv::Mat[0]
      â”œâ”€â”€ cv::Mat[1]
      â””â”€â”€ cv::Mat[7]
```

- æ¯å€‹å…ƒç´ çš„ cv::Mat header åœ¨ heap ä¸Šã€‚
å¯¦éš›å½±åƒ buffer é‚„æ˜¯ç¨ç«‹å­˜åœ¨ heap/GPUã€‚

ğŸ” ä¸‰ã€å‚³éï¼ˆPassabilityï¼‰

| æ“ä½œ             | `cv::Mat images[batch];`               | `std::vector<cv::Mat> images(batch);`                        |
| -------------- | -------------------------------------- | ------------------------------------------------------------ |
| å‡½å¼å‚³é           | æœƒ decay æˆ `cv::Mat*`ï¼Œæ‰€ä»¥éœ€å¦å¤–å‚³ `batch` å¤§å° | å¯ç›´æ¥å‚³ `std::vector<cv::Mat>&` æˆ– `const std::vector<cv::Mat>&` |
| å›å‚³ä½¿ç”¨           | âŒ ä¸å¯ç›´æ¥ return é™£åˆ—                       | âœ… å¯ return vector                                            |
| move semantics | âŒ ç„¡æ³•ç§»å‹•ï¼ˆé™£åˆ—æ˜¯å›ºå®šçµæ§‹ï¼‰                        | âœ… å®Œæ•´æ”¯æ´ move / copy / swap                                    |
| STL ç›¸å®¹æ€§        | âŒ ä¸æ”¯æ´                                  | âœ… å¯æ­é… `std::for_each`ã€`std::transform`ã€range-based loop      |

ğŸ§  å››ã€åœ¨ GPU / CUDA å‰è™•ç†ä¸­çš„å½±éŸ¿
- cv::Mat images[batch];
âœ… å„ªé»ï¼š
- é©åˆã€Œå›ºå®š batchã€ä½é–‹éŠ·ã€å ´æ™¯ã€‚
- stack åˆ†é…é€Ÿåº¦å¿«ï¼ˆä¸æœƒ malloc/freeï¼‰ã€‚
- header é€£çºŒï¼Œå¯ç”¨ pointer éæ­·ï¼Œæ–¹ä¾¿å‚³çµ¦ kernelã€‚
âš ï¸ ç¼ºé»ï¼š
- ç„¡æ³•å‹•æ…‹èª¿æ•´ batchã€‚
- ä¸èƒ½ç›´æ¥å‚³çµ¦éœ€è¦å®¹å™¨èªç¾©çš„ APIï¼ˆä¾‹å¦‚ std::ranges æˆ– std::vector<cv::cuda::GpuMat> æ··åˆï¼‰ã€‚
- å¦‚æœ batch å¤ªå¤§ï¼Œstack å®¹æ˜“çˆ†ï¼ˆ>1MBï¼‰ã€‚
- std::vector<cv::Mat> images(batch);
âœ… å„ªé»ï¼š
- å®¹å™¨å¯å‹•æ…‹ç®¡ç†ã€å‚³éå®‰å…¨ã€‚
- æ›´é©åˆ pipeline å¼æ¶æ§‹ï¼ˆåƒä½ åœ¨åšçš„ multi-stream inferenceï¼‰ã€‚
- æ”¯æ´ moveï¼Œèƒ½å®‰å…¨åœ¨ä»»æ„å‡½å¼ä¹‹é–“å‚³éã€‚
- è·Ÿ STL / thrust / TensorRT binding æ›´ç›¸å®¹ã€‚
âš ï¸ ç¼ºé»ï¼š
- å»ºç«‹æ™‚æœƒå‘¼å« heap allocatorï¼ˆå¤šä¸€å±¤æŒ‡æ¨™é–“æ¥æ€§ï¼‰ã€‚
- å¤§é‡å° vector å¯èƒ½å°è‡´è¨˜æ†¶é«”ç¢ç‰‡åŒ–ï¼ˆä½†å¯ç”¨ reserve() è§£æ±ºï¼‰ã€‚

ğŸ§© äº”ã€å¯¦å‹™å»ºè­°ï¼ˆé‡å°ä½ çš„å ´æ™¯ï¼‰

| å ´æ™¯                                                         | å»ºè­°å¯«æ³•                                                                         |
| ---------------------------------------------------------- | ---------------------------------------------------------------------------- |
| CUDA kernel å‰çš„ batch warpAffineã€å›ºå®š batch å¤§å°                | `cv::Mat images[BATCH_SIZE];`ï¼ˆå¿«é€Ÿå­˜å–ï¼‰                                          |
| å¤š stream / å‹•æ…‹ batch pipelineï¼ˆå« pybind æˆ– TensorRT pipelineï¼‰ | `std::vector<cv::Mat>`ï¼ˆéˆæ´»ã€å®‰å…¨ï¼‰                                                |
| GPU buffer pool / zero-copy buffer reuse                   | å„²å­˜æˆ `std::vector<cv::cuda::GpuMat>` æˆ–è‡ªå®šç¾© structï¼Œä¸¦æ­é… pointer array å‚³éçµ¦ kernel |

ğŸ’¡ å°å»¶ä¼¸ï¼ˆå¦‚æœä½ è¦çµ¦ CUDA ç”¨ï¼‰
å‡è¨­ä½ è¦å‚³å¤šå¼µåœ–ç‰‡çš„ data pointer çµ¦ GPU kernelï¼š

``` cpp
std::vector<cv::Mat> images(batch);
std::vector<uint8_t*> d_ptrs(batch);
for (int i = 0; i < batch; ++i)
    d_ptrs[i] = images[i].data;

cudaMemcpy(d_srcArray, d_ptrs.data(), batch * sizeof(uint8_t*), cudaMemcpyHostToDevice);
```

é€™æ™‚ std::vector æ¯”é™£åˆ—æ›´æ–¹ä¾¿ï¼ˆå› ç‚º .data() å¯ä»¥ç›´æ¥å–æŒ‡æ¨™ï¼Œä¸”é•·åº¦å‹•æ…‹ï¼‰ã€‚

ç¸½çµä¸€å¥è©±ï¼š
ğŸš€ å¦‚æœä½ åœ¨å¯«åº•å±¤ CUDA kernel demoï¼Œç”¨é™£åˆ—ã€‚
å¦‚æœä½ åœ¨è¨­è¨ˆæ¨¡çµ„åŒ– inference pipelineï¼Œç”¨ vectorã€‚
### page faultï¼ˆé éŒ¯ / é é¢éŒ¯èª¤ï¼‰ é€™å€‹æ¦‚å¿µï¼Œé€™æ˜¯ä½œæ¥­ç³»çµ±è¨˜æ†¶é«”ç®¡ç†ä¸­éå¸¸æ ¸å¿ƒçš„ä¸€ç’°ã€‚

ğŸ§  ä¸€å¥è©±è§£é‡‹

Page fault æ˜¯ç•¶ CPU å˜—è©¦å­˜å–æŸå€‹ã€Œç›®å‰ä¸åœ¨å¯¦é«”è¨˜æ†¶é«”ä¸­çš„è™›æ“¬é ã€æ™‚ï¼Œè§¸ç™¼çš„ä¸€å€‹ä¾‹å¤–ï¼ˆexceptionï¼‰ã€‚
ç³»çµ±æœƒè—‰æ­¤æ©Ÿæœƒå»æŠŠé‚£å€‹é é¢è¼‰å…¥ï¼ˆæˆ–å ±éŒ¯ï¼‰ï¼Œå†è®“ç¨‹å¼ç¹¼çºŒåŸ·è¡Œã€‚

ğŸ§© é‹ä½œæ©Ÿåˆ¶æµç¨‹ï¼ˆç°¡åŒ–ç¤ºæ„ï¼‰

``` bash
ç¨‹å¼å­˜å–è™›æ“¬ä½å€ â†’ MMU æª¢æŸ¥é è¡¨ â†’ ç™¼ç¾é ä¸å­˜åœ¨
       â†“
   è§¸ç™¼ Page Fault ä¾‹å¤–
       â†“
OS ä»‹å…¥ï¼ˆPage Fault Handlerï¼‰
       â†“
1ï¸âƒ£ åˆ¤æ–·åŸå› ï¼ˆé åœ¨ç£ç¢Ÿï¼Ÿæ¬Šé™éŒ¯èª¤ï¼Ÿéæ³•å­˜å–ï¼Ÿï¼‰
2ï¸âƒ£ è‹¥é åœ¨ç£ç¢Ÿï¼Œå¾ swap / file è¼‰å…¥åˆ° RAM
3ï¸âƒ£ æ›´æ–°é è¡¨ï¼ˆpage tableï¼‰
4ï¸âƒ£ æ¢å¾©ç¨‹å¼åŸ·è¡Œ
```

ğŸ“‚ Page Fault çš„ç¨®é¡

| é¡å‹                           | èªªæ˜                                     | æ˜¯å¦æ­£å¸¸                                    |
| ---------------------------- | -------------------------------------- | --------------------------------------- |
| **Minor Page Faultï¼ˆæ¬¡è¦é éŒ¯ï¼‰**   | é ä¸åœ¨é€²ç¨‹çš„é è¡¨ä¸­ï¼Œä½†å·²åœ¨ RAMï¼ˆä¾‹å¦‚å…±äº«é è¢« unmap å¾Œåˆ mapï¼‰ | âœ… å¸¸è¦‹ã€å¿«é€Ÿ                                 |
| **Major Page Faultï¼ˆä¸»è¦é éŒ¯ï¼‰**   | é ä¸åœ¨ RAMï¼Œéœ€è¦å¾ç£ç¢Ÿè¼‰å…¥                        | âš ï¸ æ¯”è¼ƒæ…¢                                  |
| **Invalid Page Faultï¼ˆéæ³•é éŒ¯ï¼‰** | å­˜å–ä¸å­˜åœ¨æˆ–ç„¡æ¬Šé™çš„é                             | âŒ Segmentation fault / Access violation |

ğŸ’¾ èˆ‰å€‹å¯¦éš›ä¾‹å­ï¼ˆLinuxï¼‰

å‡è¨­ä½ æœ‰å€‹ç¨‹å¼ï¼š

``` cpp
int main() {
    int *arr = (int*)malloc(1024 * 1024 * sizeof(int));
    arr[0] = 42;
    return 0;
}
```

é€™è£¡ï¼š

malloc() åªé…ç½®è™›æ“¬ä½å€ç©ºé–“ï¼Œæ²’æœ‰ç«‹åˆ»åˆ†é…å¯¦é«” RAMã€‚

ç•¶ä½ ç¬¬ä¸€æ¬¡ arr[0] = 42; æ™‚ï¼Œ
CPU ç™¼ç¾è©²é æœªè¼‰å…¥ï¼Œç”¢ç”Ÿ page faultã€‚

OS åˆ†é…å¯¦é«”é  â†’ æ›´æ–°é è¡¨ â†’ ç¨‹å¼ç¹¼çºŒåŸ·è¡Œã€‚

âœ… æ‰€ä»¥é€™æ˜¯ã€Œæ­£å¸¸ page faultã€ï¼Œæ˜¯å»¶é²é…ç½®ï¼ˆlazy allocationï¼‰ çš„ä¸€éƒ¨åˆ†ã€‚

ğŸ§® åœ¨ Linux ä¸‹è§€å¯Ÿ page fault

``` bash
cat /proc/<pid>/stat | awk '{print "minor:", $10, "major:", $12}'
```

æˆ–ç”¨ timeï¼š

``` bash
/usr/bin/time -v ./your_program
```

ä½ æœƒçœ‹åˆ°ï¼š

``` bash
Minor (reclaim) page faults: 123
Major (requiring I/O) page faults: 2
```

èˆ‡ CUDA / Unified Memory çš„é—œä¿‚

å¦‚æœä½ æœ€è¿‘åœ¨ç© CUDA Unified Memoryï¼ˆcudaMallocManagedï¼‰ï¼Œé‚£å°±æ›´ relevant äº†ã€‚
å› ç‚º Unified Memory å°±æ˜¯é ã€Œpage fault-driven migrationã€å¯¦ç¾ CPU/GPU è¨˜æ†¶é«”ä¸€è‡´æ€§ã€‚

â¡ï¸ ç•¶ GPU å˜—è©¦å­˜å–ä¸€å€‹ç›®å‰åªåœ¨ host ç«¯çš„é ï¼š

æœƒè§¸ç™¼ GPU page fault
driver æœƒå°‡é‚£å€‹é  migrate åˆ° GPU è¨˜æ†¶é«”
æ›´æ–° page table
ä¹‹å¾Œè©²é å±¬æ–¼ GPU domain
é€™å°±æ˜¯ã€ŒLazy Memory Migrationã€çš„åº•å±¤å¯¦ä½œä¹‹ä¸€ã€‚

ğŸ§¨ å»¶ä¼¸é–±è®€é—œéµè©

Demand paging
Page table & TLB
Copy-on-write
NUMA page migration
CUDA Unified Memory Fault Handling
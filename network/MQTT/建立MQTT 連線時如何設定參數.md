### 建立MQTT 連線時如何設定參數
建立一個MQTT 連線是使用MQTT 協定進行通訊的第一步。為了確保高可擴展性，在建立連接時MQTT 協定提供了豐富的連接參數，以方便開發者創造滿足不同業務需求的物聯網應用。本文將詳細說明MQTT 中各個連結參數的作用，幫助開發者踏出使用MQTT 的第一步。

#### MQTT 連結的基本概念
MQTT 連線由客戶端向伺服器端發起。任何運行了MQTT 客戶端庫的程式或設備都是一個MQTT 客戶端，而MQTT 伺服器則負責接收客戶端發起的連接，並將客戶端發送的訊息轉發到另外一些符合條件的客戶端。
用戶端與伺服器建立網路連線後，需要先傳送一個 封包給CONNECT伺服器。伺服器收到CONNECT包後會回覆一個CONNACK給客戶端，客戶端收到CONNACK包後表示MQTT 連線建立成功。如果用戶端在逾時時間內未收到伺服器的CONNACK封包，就會主動關閉連線。

大多數場景下，MQTT 透過TCP/IP 協定進行網路傳輸，但MQTT 同時也支援透過WebSocket 或UDP 進行網路傳輸。

#### MQTT over TCP
TCP/IP 應用廣泛，是一種面向連接的、可靠的、基於位元組流的傳輸層通訊協定。它透過ACK 確認和重送機制，能夠保證發送的所有位元組在接收時是完全一樣的，而且位元組順序也是正確的。

MQTT 通常基於TCP 進行網路通信，它繼承了TCP 的許多優點，能穩定運作在低頻寬、高延遲、及資源受限的環境下。

#### MQTT over WebSocket
近年來隨著Web 前端的快速發展，瀏覽器新特性層出不窮，越來越多的應用可以在瀏覽器端透過瀏覽器渲染引擎實現，Web 應用的即時通訊方式WebSocket 也因此得到了廣泛的應用。

很多物聯網應用需要以Web 的方式被使用，例如許多設備監控系統需要使用瀏覽器即時顯示設備數據。但是瀏覽器是基於HTTP 協定傳輸資料的，也就無法使用MQTT over TCP。

MQTT 協定在創建之初便考慮到了Web 應用的重要性，它支援透過MQTT over WebSocket 的方式進行MQTT 通訊。

#### MQTT 連接參數的使用
**連接位址**
MQTT 的連線位址通常包含：伺服器IP 或網域名稱、伺服器連接埠、連線協定。
    **基於TCP 的MQTT 連接**
        mqtt是普通的TCP 連接，連接埠一般為1883。
        mqtts是基於TLS/SSL 的安全連接，連接埠一般為8883。
        例如mqtt://broker.emqx.io:1883是一個基於普通TCP 的MQTT 連接位址。
    **基於WebSocket 的連接**
        ws是普通的WebSocket 連接，連接埠一般為8083。
        wss是基於WebSocket 的安全連接，連接埠一般為8084。
        當使用WebSocket 連線時，連線位址還需要包含Path， EMQX 預設配置的Path 是/mqtt。例如ws://broker.emqx.io:8083/mqtt是一個基於WebSocket 的MQTT 連線位址。
#### 客戶端ID（Client ID）
MQTT 伺服器使用Client ID 來識別客戶端，連接到伺服器的每個客戶端都必須要有唯一的Client ID。 Client ID 的長度通常為1 至23 個位元組的UTF-8 字串。
**如果客戶端使用一個重複的Client ID 連線至伺服器，將會把已使用該Client ID 連線成功的客戶端踢下線。**
#### 使用者名稱與密碼（Username & Password）
MQTT 協定可以透過使用者名稱和密碼來進行相關的認證和授權，但如果此資訊未加密，則使用者名稱和密碼將以明文方式傳輸。如果設定了使用者名稱與密碼認證，那麼最好要使用mqtts或wss協定。
大多數MQTT 伺服器預設為匿名認證，匿名認證時使用者名稱與密碼設定為空字串即可。
#### 連線逾時（Connect Timeout）
連線逾時時長，收到伺服器連線確認前的等待時間，等待時間內未收到連線確認則為連線失敗。
#### 保活週期（Keep Alive）
保活週期，是一個以秒為單位的時間間隔。當客戶端在無報文發送時，將按Keep Alive 設定的值定時向服務端發送心跳報文，確保連線不會被服務端中斷。
在連線建立成功後，如果伺服器沒有在Keep Alive 的1.5 倍時間內收到來自客戶端的任何包，則會認為和客戶端之間的連線出現了問題，此時伺服器便會中斷和客戶端的連線。
更多細節可查看部落格：MQTT 協議中的Keep Alive 機制。
#### 清除會話（Clean Session）
為false時表示建立持久會話，當客戶端斷開連線時，會話仍然保持並保存離線訊息，直到會話逾時登出。為true時表示建立一個新的臨時會話，在客戶端中斷時，會話自動銷毀。
持久會話避免了用戶端斷線重連後訊息的遺失，並且免去了用戶端連線後重複的訂閱開銷。這項功能在頻寬小，網路不穩定的物聯網場景中非常實用。
伺服器為持久會話保存的訊息數量取決於伺服器的配置，例如EMQ 提供的免費的公共MQTT 伺服器設定的離線訊息保存時間為5 分鐘，最大訊息數為1000 條，且不保存QoS 0 訊息。
注意：持久會話恢復的前提是客戶端使用固定的Client ID 再次連接，如果Client ID 是動態的，那麼連接成功後將會建立一個新的持久性會話。
#### 遺囑消息（Last Will）
遺囑訊息是MQTT 為那些可能出現意外斷線的設備提供的將遺囑優雅地發送給其他客戶端的能力。設定了遺囑訊息訊息的MQTT 用戶端異常下線時，MQTT 伺服器會發布該客戶端設定的遺囑訊息。
意外斷線包括：因網路故障，連線被服務端關閉；設備意外掉電；設備嘗試進行不被允許的操作而被服務端關閉連線等。
遺囑訊息可以看作是一個簡化版的MQTT 訊息，它也包含Topic、Payload、QoS、Retain 等資訊。
當設備意外斷線時，遺囑訊息將發送至遺囑Topic；
遺囑Payload 是待發送的訊息內容；
遺囑QoS 與普通MQTT 訊息的QoS 一致，詳細請見MQTT QoS（服務品質）介紹。
遺囑Retain 為true時表明遺囑訊息是保留訊息。 MQTT 伺服器會為每個主題儲存最新一則保留訊息，以方便訊息發布後才上線的用戶端在訂閱主題時仍可接收到該訊息。詳細請見MQTT 保留訊息是什麼？如何使用？

#### 協議版本
使用較多的MQTT 協定版本有MQTT v3.1、MQTT v3.1.1 及MQTT v5.0。目前，MQTT 5.0 已成為絕大多數物聯網企業的首選協議，我們建議初次接觸MQTT 的開發者直接使用該版本。

#### MQTT 5.0 新增連線參數
**Clean Start & Session Expiry Interval**
MQTT 5.0 中將Clean Session 分拆成了Clean Start 與Session Expiry Interval。
Clean Start 用於指定連線時是建立一個全新的會話還是嘗試重複使用一個已存在的會話。為true時表示必須丟棄任何已存在的會話，並建立一個全新的會話；為false時表示必須使用與Client ID 關聯的會話來恢復與客戶端的通訊（除非會話不存在）。
Session Expiry Interval 用於指定網路連線中斷後會話的過期時間。設定為0 或未設置，表示斷開連線時會話即到期；設定為大於0 的數值，則表示會話在網路連線關閉後會維持多少秒；設定為0xFFFFFFFF 表示會話永遠不會過期。
更多細節可參閱部落格：Clean Start 與Session Expiry Interval。
**連線屬性（Connect Properties）**
MQTT 5.0 也新引入了連接屬性的概念，進一步增強了協定的可擴展性。更多細節可查看部落格：MQTT 5.0 連結屬性。
#### 如何建立一個安全的MQTT 連線？
雖然MQTT 協定提供了使用者名稱、密碼、Client ID 等認證機制，但這對物聯網安全來說還遠遠不夠。基於傳統的TCP 通訊使用明文傳輸，資訊的安全性很難得到保證，資料也會有被竊聽、竄改、偽造、冒充的風險。
SSL/TLS 的出現很好的解決了通訊中的風險問題，其以非對稱加密技術為主幹，混合了不同模式的加密方式，既保證了通訊中訊息都以密文傳輸，避免了被竊聽的風險，同時也透過簽名防止了訊息被篡改。
不同MQTT 伺服器啟用SSL/TLS 的步驟都各有不同，EMQX 內建了對TLS/SSL 的支持，包括支援單/雙向認證、X.509 憑證、負載平衡SSL 等多種安全認證。
單向認證是一種僅透過驗證伺服器憑證來建立安全通訊的方式，它能保證通訊是加密的，但是不能驗證客戶端的真偽，通常需要與使用者名稱、密碼、Client ID 等認證機制結合。讀者可參考部落格EMQX MQTT 伺服器啟用SSL/TLS 安全連線來建立一個安全的單向認證MQTT 連線。
雙向認證是指在進行通訊認證時要求服務端和用戶端都提供證書，雙方都需要進行身分認證，以確保通訊中涉及的雙方都是受信任的。 雙方彼此共享其公共證書，然後基於該證書執行驗證、確認。一些對安全性要求較高的應用場景，就需要開啟雙向SSL/TLS 認證。
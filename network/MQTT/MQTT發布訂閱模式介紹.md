### MQTT 發布訂閱模式介紹

MQTT 發布/訂閱模式
發布訂閱模式（Publish-Subscribe Pattern）是一種訊息傳遞模式，它將發送訊息的用戶端（發布者）與接收訊息的用戶端（訂閱者）解耦，使得兩者不需要建立直接的聯繫也不需要知道對方的存在。
MQTT 發布/訂閱模式的精髓在於由一個被稱為代理（Broker）的中間角色負責所有訊息的路由和分發工作，發布者將帶有主題的消息發送給代理，訂閱者則向代理訂閱主題來接收感興趣的消息。
在MQTT 中，主題和訂閱無法提前註冊或創建，所以代理也無法預知某一個主題之後是否會有訂閱者，以及會有多少訂閱者，所以只能將訊息轉發給當前的訂閱者，如果當前不存在任何訂閱，那麼訊息將被直接丟棄。
MQTT 發布/訂閱模式有4 個主要組成部分：發布者、訂閱者、代理商和主題。
- 發布者（Publisher）
    負責將訊息發佈到主題上，發布者一次只能向一個主題發送數據，發布者發布訊息時也無需關心訂閱者是否在線上。
- 訂閱者（Subscriber）
    訂閱者透過訂閱主題接收訊息，且可一次訂閱多個主題。 MQTT 也支援透過共享訂閱的方式在多個訂閱者之間實現訂閱的負載平衡。
- 代理商（Broker）
    負責接收發布者的消息，並將訊息轉發至符合資格的訂閱者。另外，代理也需要負責處理客戶端發起的連線、中斷連線、訂閱、取消訂閱等請求。
- 主題（Topic）
    主題是MQTT 進行訊息路由的基礎，它類似URL 路徑，使用斜線/進行分層，例如sensor/1/temperature。主題可以有多個訂閱者，代理會將該主題下的消息轉發給所有訂閱者；一個主題也可以有多個發布者，代理將按照訊息到達的順序轉發。

MQTT 也支援訂閱者使用主題通配符一次訂閱多個主題。
![[MQTT 發布訂閱架構.jpg]]

## MQTT 發布/訂閱中的消息路由

在MQTT 發布/訂閱模式中，一個客戶端既可以是發布者，也可以是訂閱者，也可以同時具備這兩個身分。 當客戶端發布一條訊息時，它會被傳送到代理，然後代理將訊息路由到該主題的所有訂閱者。 當客戶端訂閱主題時，它會收到代理轉發到該主題的所有訊息。

一般來說，大多數發布/訂閱系統主要透過以下兩種方式過濾並路由訊息。
- 根據主題
	訂閱者向代理商訂閱自己感興趣的主題，發布者發布的所有訊息中都會包含自己的主題，代理根據訊息的主題判斷需要將訊息轉發給哪些訂閱者。
- 根據訊息內容
	訂閱者定義其感興趣的訊息的條件，只有當訊息的屬性或內容滿足訂閱者定義的條件時，訊息才會被投遞到該訂閱者。
MQTT 協定是基於主題進行訊息路由的，在這個基礎上，EMQX 從3.1 版本開始透過基於SQL 的規則引擎提供了額外的按訊息內容進行路由的能力。

## MQTT 與HTTP 請求回應

HTTP 是萬維網資料通訊的基礎，其簡單易用無客戶端依賴，並廣泛應用於各行業。在物聯網領域，HTTP 也可以用於連接物聯網設備和Web 伺服器，實現設備的遠端監控和控制。

雖然使用簡單、開發週期短，但基於請求回應的HTTP 在物聯網領域的應用卻有一定的限制。首先，協議層面HTTP 封包相較與MQTT 需要佔用更多的網路開銷；其次，HTTP 是一種無狀態協議，這表示伺服器在處理請求時不會記錄客戶端的狀態，也無法實現從連接異常斷開中恢復；最後，請求回應模式需要透過輪詢才能取得資料更新，而MQTT 透過訂閱即可取得即時資料。

發布訂閱模式的鬆散耦合特性，也為MQTT 帶來了一些副作用。由於發布者並不知曉訂閱者的狀態，因此發布者也無法得知訂閱者是否收到了訊息，或者是否正確處理了訊息。為此，MQTT 5.0 增加了[請求回應](https://www.emqx.com/zh/blog/mqtt5-request-response)特性，以實現訂閱者收到訊息後向某個主題發送應答，發布者收到應答後再進行後續操作。

## MQTT 與訊息佇列

儘管MQTT 與訊息佇列的許多行為和特性非常接近，例如都採用發布/訂閱模式，但是他們面向的場景卻有著顯著的不同。訊息佇列主要用於服務端應用之間的訊息儲存與轉發，這類場景往往資料量大但客戶端數量少。 MQTT 是一種訊息傳輸協議，主要用於物聯網設備之間的訊息傳遞，這類場景的特徵是大量的設備存取、管理與訊息傳輸。

在一些實際的應用場景中，MQTT 與訊息佇列往往會被結合起來使用，以使MQTT 伺服器能專注於處理設備的連接與設備間的訊息路由。例如先由MQTT 伺服器接收物聯網設備上報的數據，然後再透過訊息佇列將這些數據轉送到不同的業務系統進行處理。

不同於訊息佇列，MQTT 主題不需要事先建立。[MQTT 用戶端](https://www.emqx.com/zh/blog/mqtt-client-tools)在訂閱或發佈時即自動的創建了主題，開發者無需再關心主題的創建，並且也不需要手動刪除主題。

## 結語

MQTT 的發布/訂閱機制可以輕易地滿足我們一對一、一對多、多對一的通訊需求。這也在很大程度上拓寬了MQTT 在IoT 領域之外的應用，像是網路直播互動、手機訊息推播等產業場景，都非常適合使用MQTT。
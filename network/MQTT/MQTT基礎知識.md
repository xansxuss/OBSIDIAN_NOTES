### MQTT基礎知識

1. 目錄
- 什麼是MQTT？
- 為什麼MQTT 是適用於物聯網的最佳協定？
- MQTT 的工作原理
- MQTT 的工作流程

在快速發展的物聯網領域，高效的設備通訊至關重要。 MQTT 正是實現這一目標的核心協議。本指南將帶您深入解析MQTT 這項專為低頻寬、高延遲網路設計的輕量級發布-訂閱協定。我們將系統講解MQTT 的基礎原理、核心概念和實際應用場景，透過專業洞見與實操案例結合，為您提供掌握MQTT 協定、加速物聯網專案的完整知識體系。

2. 什麼是MQTT？
MQTT（Message Queuing Telemetry Transport）是一種輕量級、基於發布-訂閱模式的訊息傳輸協議，適用於資源受限的裝置和低頻寬、高延遲或不穩定的網路環境。它在物聯網應用中廣受歡迎，能夠實現感測器、執行器和其它設備之間的高效通訊。

3. 為什麼MQTT 是適用於物聯網的最佳協定？
MQTT 所具有的適用於物聯網特定需求的特性和功能，使其成為物聯網領域最佳的協定之一。它的主要特點包括：
- 輕量級：物聯網設備通常在處理能力、記憶體和能耗方面受到限制。 MQTT 開銷低、報文小的特點使其非常適合這些設備，因為它消耗更少的資源，即使在有限的能力下也能實現高效的通訊。
- 可靠：物聯網網路常常面臨高延遲或連線不穩定的情況。 MQTT 支援多種QoS 等級、會話感知和持久連接，即使在困難的條件下也能保證訊息的可靠傳遞，使其非常適合物聯網應用。
- 安全通訊：安全對於物聯網網路至關重要，因為其經常涉及敏感資料的傳輸。為確保資料在傳輸過程中的機密性，MQTT 提供傳輸層安全性（TLS）和安全通訊端層（SSL）加密功能。此外，MQTT 還透過使用者名稱/密碼憑證或用戶端憑證提供身份驗證和授權機制，以保護網路及其資源的存取。
- 雙向通訊： MQTT 的發布-訂閱模式為設備之間提供了無縫的雙向通訊方式。客戶端既可以向主題發布訊息，也可以訂閱接收特定主題上的訊息，從而實現了物聯網生態系統中的高效資料交換，而無需直接將設備耦合在一起。這種模式也簡化了新設備的集成，同時確保了系統易於擴展。
- 連續、有狀態的會話： MQTT 提供了客戶端與Broker 之間保持有狀態會話的能力，這使得系統即使在斷開連接後也能記住訂閱和未傳遞的訊息。此外，用戶端還可以在建立連線時指定保活間隔，這會促使Broker 定期檢查連線狀態。如果連線中斷，Broker 會儲存未傳遞的訊息（根據QoS 等級決定），並在用戶端重新連線時嘗試傳遞它們。這個特性保證了通訊的可靠性，降低了因間斷性連接而導致資料遺失的風險。
- 大規模物聯網設備支援：物聯網系統往往涉及大量設備，需要一種能夠處理大規模部署的協定。 MQTT 的輕量級特性、低頻寬消耗和對資源的高效利用使其成為大規模物聯網應用的理想選擇。透過採用發布-訂閱模式，MQTT 實現了發送者和接收者的解耦，從而有效地減少了網路流量和資源使用。此外，協議對不同QoS 等級的支援使得訊息傳遞可以根據需求進行定制，確保在各種場景下獲得最佳的效能表現。
- 語言支援：物聯網系統包含使用各種程式語言開發的設備和應用。 MQTT 具有廣泛的語言支持，使其能夠輕鬆與多個平台和技術進行集成，從而實現了物聯網生態系統中的無縫通訊和互通性。您可以閱讀我們的MQTT 用戶端程式設計系列文章，學習如何在PHP、Node.js、Python、Golang、Node.js 等程式語言中使用MQTT。

4. MQTT 的工作原理
MQTT 是基於發布-訂閱模式的通訊協議，由MQTT 用戶端透過主題（Topic）發布或訂閱訊息，透過MQTT Broker 集中管理訊息路由，並依據預設的服務品質等級(QoS)確保端對端訊息傳遞可靠性。
   1. MQTT 用戶端
    任何運行MQTT 客戶端程式庫的應用程式或裝置都是MQTT 用戶端。例如，使用MQTT 的即時通訊應用是客戶端，使用MQTT 上報資料的各種感測器是客戶端，各種MQTT 測試工具也是客戶端。
   2. MQTT Broker
    MQTT Broker 是負責處理客戶端要求的關鍵元件，包括建立連線、斷開連線、訂閱和取消訂閱等操作，同時也負責訊息的轉送。一個高效強大的MQTT Broker 能夠輕鬆應對海量連接和百萬級訊息吞吐量，從而幫助物聯網服務供應商專注於業務發展，快速建立可靠的MQTT 應用。
   3. 發布-訂閱模式
    發布-訂閱模式與客戶端-伺服器模式的不同之處在於，它將發送訊息的客戶端（發布者）和接收訊息的客戶端（訂閱者）進行了解耦。發布者和訂閱者之間無需建立直接連接，而是透過MQTT Broker 來負責訊息的路由和分發。

下圖展示了MQTT 發布/訂閱流程。溫度感測器作為客戶端連接到MQTT Broker，並透過發布操作將溫度資料發佈到一個特定主題（例如Temperature）。 MQTT Broker 接收到該訊息後會負責將其轉發給訂閱了對應主題（Temperature）的訂閱者用戶端。
![[MQTT發布訂閱流程.jpg]]

**主題**
MQTT 協議根據主題來轉發訊息。主題透過`/`來區分層級，類似URL 路徑，例如：

``` bash
chat/room/1
sensor/10/temperature
sensor/+/temperature
```
MQTT 主題支援以下兩種通配符：`+`和`#`。

- `+`：表示單層通配符，例如`a/+`匹配`a/x`或`a/y`。
- `#`：表示多層通配符，例如`a/#`匹配`a/x`、`a/b/c/d`。

> **注意**：通配符主題只能用於訂閱，不能用於發布。

**QoS**

MQTT 提供了三種服務品質（QoS），在不同網路環境下保證訊息的可靠性。

- QoS 0：訊息最多傳送一次。如果當前客戶端不可用，它將丟失這條訊息。
- QoS 1：訊息至少傳送一次。
- QoS 2：訊息只會傳送一次。

5. ## MQTT 的工作流程

在了解了MQTT 的基本組件之後，讓我們來看看它的一般工作流程：

1. **用戶端使用TCP/IP 協定與Broker 建立連接**，可選擇使用TLS/SSL 加密來實現安全通訊。用戶端提供認證訊息，並指定會話類型（Clean Session 或Persistent Session）。
2. **客戶端既可以向特定主題發布訊息，也可以訂閱主題以接收訊息**。當客戶端發布訊息時，它會將訊息傳送給MQTT Broker；而當客戶端訂閱訊息時，它會接收與訂閱主題相關的訊息。
3. **MQTT Broker 接收發佈的訊息**，並將這些訊息轉發給訂閱了對應主題的用戶端。它根據QoS 等級確保訊息可靠傳遞，並根據會話類型為斷開連接的用戶端儲存訊息。

reference
[# MQTT 協定快速入門2025：基礎知識與實用教程](https://www.emqx.com/zh/blog/the-easiest-guide-to-getting-started-with-mqtt)